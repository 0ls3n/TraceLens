@page "/"

@inject StackParserService StackParser

<PageTitle>TraceLens</PageTitle>

<div class="trace-container">
    <div style="min-width: 0;">
        <h2>Input</h2>
        <div class="trace-input-container">



            <span>Paste your stack trace</span>
            <textarea @bind="trace" placeholder="Paste your stack trace here...

Example:
System.NullReferenceException: Object reference not set to an instance of an object.
   at MyApp.Services.UserService.GetUserById(Int32 id) in UserService.cs:line 42
   at MyApp.Pages.Users.OnInitializedAsync() in Users.cs:line 18
   at Microsoft.AspNetCore.Components.ComponentBase.RunInitAndSetParametersAsync()"></textarea>

            <button @onclick="ParseStackTrace">Parse stack trace</button>
        </div>
    </div>

    <div class="trace-output-container" style="min-width: 0;">

        <h2>Parsed Stack Trace</h2>

        @if (parsedStackTrace != null)
        {
            <div class="trace-cause-container">
                <span>@parsedStackTrace.MainCause</span>
            </div>

            <h4 style="opacity: 0.5;">Stack trace</h4>

            <div class="trace-node-container">
                @foreach (StackNode stackNode in parsedStackTrace.StackNodes.OrderByDescending(x => x.IsUserCode))
                {
                    <StackTraceNodeComponent StackNode="stackNode"></StackTraceNodeComponent>
                }
            </div>
        }
        else
        {
            @if (demoTrace != null)
            {
                <div class="trace-cause-container">
                    <span>@demoTrace.MainCause</span>
                </div>

                <h4 style="opacity: 0.5;">Stack trace</h4>

                <div class="trace-node-container">
                    @foreach (StackNode stackNode in demoTrace.StackNodes.OrderByDescending(x => x.IsUserCode))
                    {
                        <StackTraceNodeComponent StackNode="stackNode"></StackTraceNodeComponent>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    string trace = string.Empty;

    ParsedStackTrace? parsedStackTrace = null;

    ParsedStackTrace? demoTrace = null;

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (firstRender)
        {
            demoTrace = new ParsedStackTrace
            {
                MainCause = "System.NullReferenceException: Object reference not set to an instance of an object.",
                StackNodes = new List<StackNode>
                {
                    new StackNode
                    {
                        Method = "MyApp.Services.UserService.GetUserById(Int32 id)",
                        File = "UserService.cs",
                        Line = 42,
                        IsUserCode = true
                    },
                    new StackNode
                    {
                        Method = "MyApp.Pages.Users.OnInitializedAsync()",
                        File = "Users.razor",
                        Line = 18,
                        IsUserCode = true
                    },
                    new StackNode
                    {
                        Method = "Microsoft.AspNetCore.Components.ComponentBase.RunInitAndSetParametersAsync()",
                        File = null,
                        Line = 0,
                        IsUserCode = false
                    }
                }
            };
            
            StateHasChanged();
        }
    }

    public void ParseStackTrace()
    {
        parsedStackTrace = StackParser.ParseStackTrace(trace);

        StateHasChanged();
    }

}